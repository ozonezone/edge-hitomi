"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e="gold-usergeneratedcontent.net",t="https://",a="INVALID_VALUE",s="DUPLICATED_ELEMENT",n="LACK_OF_ELEMENT",r="REQUEST_REJECTED",i=" must be ",o=" must have ",l=" must not be ",g="Request error on ",h="valid",c="duplicated",d="more elements",u=new Set(["artist","group","type","language","series","character","tag","male","female"]),p=new Set(["doujinshi","manga","artistcg","gamecg","anime","imageset"]),f=Symbol("isNegative"),m=class extends Error{constructor(e,...t){const a=y[e];if(!a)throw new Error(`Unknown error code: ${e}`);super(a(t)),this.name=`HitomiError[${e}]`}},y={[a]:e=>`${e[0]}${i}${e[1]||h}`,[s]:e=>`${e[0]}${l}${c}`,[n]:e=>`${e[0]}${o}${e[1]||d}`,[r]:e=>`${g}[${e[0]}]: ${e[1]}`},w=fetch,$=async function(a,s){const n={method:"GET",headers:{...s||{},Accept:"*/*",Connection:"keep-alive",Referer:`${t}${e}`,Origin:`${t}${e}`}},i=await w(a,n);if(![200,206].includes(i.status))throw new m(r,i.status,a);if(!i?.body)throw new m(r,422,a);return i};async function b(e){const t=await e.arrayBuffer();return new Uint8Array(t)}async function v(s,n){const r=await $(`${t}ltn.${e}/galleries/${s}.js`,n).then(e=>e.text()).then(e=>JSON.parse(e.replace(/^var +\w+ *= */,"")));return{id:Number.parseInt(r.id),title:{display:r.title,japanese:r.japanese_title},type:r.type,languageName:{english:r.language,local:r.language_localname},artists:r.artists?.map(({artist:e})=>e)||[],groups:r.groups?.map(({group:e})=>e)||[],series:r.parodys?.map(({parody:e})=>e)||[],characters:r.characters?.map(({character:e})=>e)||[],tags:r.tags?.map(({tag:e,male:t,female:s})=>{if(t||s){if(""!=t||1!=s&&"1"!=s){if(""!=s||1!=t&&"1"!=t)throw new m(a,e);return{type:"male",name:e}}return{type:"female",name:e}}return{type:"tag",name:e}})||[],files:r.files?.map(({hash:e,name:t,hasavif:a,haswebp:s,hasjxl:n,width:r,height:i},o)=>({index:o,hash:e,name:t,hasAvif:Boolean(a),hasWebp:Boolean(s),hasJxl:Boolean(n),width:r,height:i}))||[],publishedDate:new Date(r.date),translations:r.languages?.map(({galleryid:e,language_localname:t,name:a})=>({id:e,languageName:{english:a,local:t}})),relatedIds:r.related}}function x(a={}){let s,n="";return"language"===a.tag?.type?s=a.popularityOrderBy?`-${a.tag.name}`:`index-${a.tag.name}`:"female"===a.tag?.type||"male"===a.tag?.type?(n="tag/",s=`/${a.tag.type}:${encodeURIComponent(a.tag.name)}-all`):a.tag?(n=`${a.tag?.type}/`,s=`/${encodeURIComponent(a.tag.name)}-all`):s=a.popularityOrderBy?"-all":"index-all",a.popularityOrderBy&&(s="day"===a.popularityOrderBy?`popular/today${s}`:`popular/${a.popularityOrderBy}${s}`),`${t}ltn.${e}/${n}${s}.nozomi`}function U(e,t=!1){const s=e.length;if(3&s)throw new m(a,"buffer length","multiple of 4");const n=new Set;n[f]=t;for(let t=0;t<s;t+=4)n.add(255===e[t]?(e[t+1]<<16|e[t+2]<<8|e[t+3])-16777216:e[t+1]<<16|e[t+2]<<8|e[t+3]);return n}async function E(e){const t=(new TextEncoder).encode(e),a=await crypto.subtle.digest("SHA-256",t);return new Uint8Array(a.slice(0,4))}var I=class{view;offset=0;constructor(e){this.view=new DataView(e)}readInt32BE(){const e=this.view.getInt32(this.offset,!1);return this.offset+=4,e}readBigUInt64BE(){const e=this.view.getBigUint64(this.offset,!1);return this.offset+=8,e}readBytes(e){const t=new Uint8Array(this.view.buffer,this.view.byteOffset+this.offset,e);return this.offset+=e,t}get position(){return this.offset}};async function B(a,s){const n=await $(`${t}ltn.${e}/galleriesindex/galleries.${s}.index`,{Range:`bytes=${a}-${a+463n}`});if(206===n.status){const e=await n.arrayBuffer();if(e.byteLength>0)return function(e){const t=new I(e),a={keys:[],datas:[],subnodeAddresses:[]},s=t.readInt32BE();for(let e=0;e<s;e++){const e=t.readInt32BE();if(!(e>0&&e<32))throw new Error("Invalid keySize: must be between 1 and 31");a.keys.push(t.readBytes(e))}const n=t.readInt32BE();for(let e=0;e<n;e++)a.datas.push([t.readBigUInt64BE(),t.readInt32BE()]);for(let e=0;e<17;e++)a.subnodeAddresses.push(t.readBigUInt64BE());return a}(e)}}function A(e,t){const a=Math.min(e.length,t.length);for(let s=0;s<a;s++)if(e[s]!==t[s])return e[s]<t[s]?-1:1;return e.length-t.length}async function C(e,t,a){if(0===t.keys.length)return;let s=0,n=-1;for(;s<t.keys.length&&(n=A(e,t.keys[s]),!(n<=0));)s++;if(0===n)return t.datas[s];if(0n===t.subnodeAddresses[s])return;if(t.subnodeAddresses.every(e=>0n===e))return;const r=await B(t.subnodeAddresses[s],a);return r?C(e,r,a):void 0}async function N(a={}){const s=await $(`${t}ltn.${e}/galleriesindex/version`),n=await s.text();let r;const i=x({popularityOrderBy:a.popularityOrderBy}),o=void 0!==a.range?.start||void 0!==a.range?.end?{Range:`bytes=${4*(a.range?.start??0)}-${4*(a.range?.end??0)-1}`}:void 0;if(r=U(await $(i,o).then(e=>b(e)).then(e=>e)),a.title?.trim()){const s=a.title.toLowerCase().trim().split(/\s+/);for(const a of s){if(!a)continue;const s=await E(a),i=await B(0n,n);if(!i)continue;const o=await C(s,i,n);if(!o){r=U(new Uint8Array(0));break}const[l,g]=o,h=`${t}ltn.${e}/galleriesindex/galleries.${n}.data`,c=`bytes=${l+4n}-${l+BigInt(g)-1n}`,d=U(await $(h,{Range:c}).then(e=>b(e)).then(e=>e)),u=U(new Uint8Array(0));u[f]=r[f];for(const e of r)d.has(e)&&u.add(e);if(r=u,0===r.size)break}}if(a.tags?.length)for(const e of a.tags){const t=x({tag:e}),a=U(await $(t).then(e=>b(e)).then(e=>e),e.isNegative);if(e.isNegative)for(const e of a)r.delete(e);else for(const e of r)a.has(e)||r.delete(e)}let l=Array.from(r);if(a.range&&(a.title||a.tags)){const e=a.range.start||0,t=a.range.end||l.length;l=l.slice(e,t)}return l}function O(e,t){const s=new Set;return e.split(t||/\s+/).forEach(e=>{const t=e.startsWith("-"),[n,r]=(t?e.slice(1):e).split(":").map(e=>e.trim());if(!u.has(n))throw new m(a,n);s.add({type:n,name:r,isNegative:t})}),s}function T(s,r){if("language"===s)return`${t}ltn.${e}/language_support.js`;if(!r)throw new m(n,"non-language types","startsWith");if("0-9"!==r&&!/^[a-z]$/.test(r))throw new m(a,"startsWith");if(!u.has(s)||"type"===s)throw new m(a,"type");let i="all";return i+="tag"===s||"female"===s||"male"===s?"tags":"series"===s?s:s+"s",i+=`-${"0-9"!==r?r:"123"}.html`,`${t}${e}/${i}`}async function R(e,t){if(!u.has(e))throw new m(a,"type");if("type"===e)return Promise.resolve(Array.from(p,e=>({type:"type",name:e})));const s=T(e,t),n=await $(s).then(e=>e.text()).then(e=>e);if("language"===e){const e=JSON.parse(n.replace(/^\/(.|\n)*language_localname *= */,"").replace(/;$/,""));return Object.entries(e).map(([e])=>({type:"language",name:e}))}const r=[],i=new RegExp(("male"===e||"female"===e?`/${e}%3A`:`${e}/`)+"[^-]+","g"),o=n.match(i);return o?(o.map(t=>{"male"===e||"female"===e?r.push({type:e,name:decodeURIComponent(t.replace(`/${e}%3A`,""))}):"tag"===e?t.includes("male%3A")||r.push({type:e,name:decodeURIComponent(t.replace("tag/",""))}):r.push({type:e,name:decodeURIComponent(t.replace(`${e}/`,""))})}),r):r}function S(s){if("anime"!==s.type)throw new m(a,"type","anime");return`${t}streaming.${e}/videos/${s.title.display.toLowerCase().replace(/\s/g,"-")}.mp4`}function k(a){return`${t}${e}/galleries/${"string"==typeof a||"number"==typeof a?a:a.id}.html`}var _=class{static#e;static#t;static#a=new Set;static#s;static async synchronize(){this.#s=await $(`${t}ltn.${e}/gg.js`).then(async e=>await e.text());let s=0,n=this.#s.indexOf("\n");for(this.#a.clear();-1!==n;){switch(this.#s[s]){case"c":this.#a.add(Number(this.#s.slice(s+5,n-1)));break;case"o":this.#t="0"===this.#s[s+4];break;case"b":this.#e=this.#s.slice(s+4,n-2)}s=n+1,n=this.#s.indexOf("\n",s)}if(this.#a.has(NaN))throw this.#a.clear(),new m(a,"/gg.js")}static getImageUri(s,n,r){if(!r?.isThumbnail&&r?.isSmall)throw new m(a,"isSmall","used w/ isThumbnail");if(!this.#a.size)throw new m(a,"getImageUri","called after synchronize");if(!s[`has${n[0].toUpperCase()}${n.slice(1)}`])throw new m(a,`${s.name}`,`${n}`);let i=n[0];const o=[s.hash.slice(-1),s.hash.slice(-3,-1)],l=Number.parseInt(o[0]+o[1],16);let g;return r?.isThumbnail?(g=n,g+=r?.isSmall?"smalltn":"bigtn",g+=`/${o[0]}/${o[1]}`,i=(this.#a.has(l)===this.#t?"a":"b")+"tn"):(g=`${this.#e}/${l}`,i=n[0]+(this.#a.has(l)===this.#t?"1":"2")),`${t}${i}.${e}/${g}/${s.hash}.${n}`}},j={getGallery:v,getGalleryIds:N,getParsedTags:O,getTags:R,getNozomiUri:x,getTagUri:T,getVideoUri:S,getGalleryUri:k,ImageUriResolver:_,edgeFetch:$};exports.ImageUriResolver=_,exports.default=j,exports.edgeFetch=$,exports.getGallery=v,exports.getGalleryIds=N,exports.getGalleryUri=k,exports.getNozomiUri=x,exports.getParsedTags=O,exports.getTagUri=T,exports.getTags=R,exports.getVideoUri=S,exports.setFetch=function(e){w=e};